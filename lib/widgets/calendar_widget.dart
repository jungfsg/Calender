import 'package:flutter/material.dart';
import 'package:table_calendar/table_calendar.dart';
import '../controllers/calendar_controller.dart';
import '../managers/event_manager.dart';
import '../managers/popup_manager.dart';
import '../widgets/weather_calendar_cell.dart';
import '../models/weather_info.dart';
import '../widgets/event_popup.dart';
import '../widgets/time_table_popup.dart';
import '../widgets/weather_summary_popup.dart';
import '../widgets/side_menu.dart';
import '../widgets/common_navigation_bar.dart';
import '../utils/font_utils.dart';
import '../services/google_calendar_service.dart';
import '../services/weather_service.dart';
import '../services/stt_command_service.dart'; // ÏùåÏÑ± Î™ÖÎ†π ÏÑúÎπÑÏä§ ÏûÑÌè¨Ìä∏
import '../screens/chat_screen.dart'; // EmptyPage Ï∂îÍ∞Ä

/// Ï∫òÎ¶∞Îçî ÏúÑÏ†Ø - ÏàúÏàò UI Ïª¥Ìè¨ÎÑåÌä∏
class CalendarWidget extends StatefulWidget {
  final CalendarController controller;
  final EventManager eventManager;
  final PopupManager popupManager;
  final VoidCallback? onLogout;

  const CalendarWidget({
    super.key,
    required this.controller,
    required this.eventManager,
    required this.popupManager,
    this.onLogout,
  });

  @override
  State<CalendarWidget> createState() => _CalendarWidgetState();
}

class _CalendarWidgetState extends State<CalendarWidget> {
  int _selectedIndex = 0;
  final CalendarFormat _calendarFormat = CalendarFormat.month;
  final GoogleCalendarService _googleCalendarService = GoogleCalendarService();
  @override
  void initState() {
    super.initState();
  }

  @override
  Widget build(BuildContext context) {
    // ÌòÑÏû¨ ÏõîÏùò Ï£º Ïàò Í≥ÑÏÇ∞
    final DateTime firstDay = DateTime(
      widget.controller.focusedDay.year,
      widget.controller.focusedDay.month,
      1,
    );
    final DateTime lastDay = DateTime(
      widget.controller.focusedDay.year,
      widget.controller.focusedDay.month + 1,
      0,
    );

    // Ï£º ÏãúÏûëÏùºÏóê ÎßûÎäî ÏöîÏùº Ïò§ÌîÑÏÖã Í≥ÑÏÇ∞
    final int firstWeekday = (firstDay.weekday % 7); // 0: Ïùº, 1: Ïõî, ... 6: ÌÜ†
    // ÎßàÏßÄÎßâ ÎÇ†Ïùò ÎÇ†Ïßú
    final int lastDate = lastDay.day;

    // Ï†ïÌôïÌïú Ï£º Ïàò Í≥ÑÏÇ∞
    final int totalWeeks = ((firstWeekday + lastDate) / 7).ceil();
    return Scaffold(
      resizeToAvoidBottomInset: false,
      backgroundColor: Color.fromARGB(255, 162, 222, 141),
      // Ï∫òÎ¶∞Îçî ÌôîÎ©¥ Í∞ÄÏû• Îí∑ Î†àÏù¥Ïñ¥Ïùò Î∞∞Í≤ΩÏÉâ
      // OS ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò Î∞î ÏúÑÏπòÏùò ÏÉâÏÉÅÎèÑ Í∞ôÏù¥ Î∞îÎÄåÎØÄÎ°ú Ïï± ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò Î∞îÏùò ÏÉâÏÉÅÍ≥º ÏùºÏπòÏãúÏºúÏïº Ìï®
      drawer: CalendarSideMenu(
        onWeatherForecastTap: () async {
          // WeatherService ÏßÅÏ†ë Ìò∏Ï∂ú
          await WeatherService.loadCalendarWeather(widget.controller);
          widget.popupManager.showWeatherForecastDialog();
          setState(() {});
        },
        onGoogleCalendarDownload: () async {
          try {
            _showSnackBar('Google Calendar ÎèôÍ∏∞Ìôî ÏãúÏûë...');

            // ÎèôÍ∏∞Ìôî Ï≤òÎ¶¨ (ÎÇ¥Î∂ÄÏ†ÅÏúºÎ°ú Ïù¥Î≤§Ìä∏ÎèÑ Î¶¨Î°úÎìúÌï®)
            await widget.eventManager.syncWithGoogleCalendar();

            // UI Í∞ïÏ†ú ÏÉàÎ°úÍ≥†Ïπ®
            setState(() {});

            _showSnackBar('Google Calendar ÎèôÍ∏∞Ìôî ÏôÑÎ£å!');
          } catch (e) {
            _showSnackBar('ÎèôÍ∏∞Ìôî Ïã§Ìå®: $e');
          }
        },
        onGoogleCalendarUpload: () async {
          try {
            await widget.eventManager.uploadToGoogleCalendar();
            _showSnackBar('Ïï± ‚Üí Google Calendar ÏóÖÎ°úÎìú ÏôÑÎ£å! (Ï§ëÎ≥µ Î∞©ÏßÄ Ï†ÅÏö©)');
          } catch (e) {
            _showSnackBar('ÏóÖÎ°úÎìú Ïã§Ìå®: $e');
          }
        },
        onLogoutTap: widget.onLogout ?? () {},
        isGoogleCalendarConnected: _googleCalendarService.isSignedIn,
      ),
      body: SafeArea(
        bottom: false,
        child: LayoutBuilder(
          builder: (context, constraints) {
            final availableHeight = constraints.maxHeight;
            const monthHeaderHeight = 65.0;
            const dayOfWeekHeaderHeight = 35.0;
            final weekHeight =
                (availableHeight -
                    monthHeaderHeight -
                    dayOfWeekHeaderHeight -
                    16.0) /
                totalWeeks;

            return Stack(
              children: [
                // Ï∫òÎ¶∞Îçî Î∂ÄÎ∂Ñ
                Padding(
                  padding: const EdgeInsets.fromLTRB(3.0, 3.0, 3.0, 0),
                  child: Container(
                    color: Colors.white,
                    child: TableCalendar(
                      firstDay: DateTime.utc(2020, 1, 1),
                      lastDay: DateTime.utc(2030, 12, 31),
                      focusedDay: widget.controller.focusedDay,
                      calendarFormat: _calendarFormat,
                      daysOfWeekHeight: dayOfWeekHeaderHeight,
                      rowHeight: weekHeight,
                      selectedDayPredicate: (day) {
                        return isSameDay(widget.controller.selectedDay, day);
                      },
                      onDaySelected: (selectedDay, focusedDay) {
                        widget.controller.setSelectedDay(selectedDay);
                        widget.controller.setFocusedDay(focusedDay);
                        widget.popupManager.showEventDialog();
                        setState(() {});
                      },
                      onPageChanged: (focusedDay) async {
                        print(
                          'üìÖ Ïõî Î≥ÄÍ≤ΩÎê®: ${focusedDay.year}ÎÖÑ ${focusedDay.month}Ïõî',
                        );

                        widget.controller.setFocusedDay(focusedDay);
                        widget.controller.hideAllPopups();

                        // üî• Ïõî Î≥ÄÍ≤Ω Ïãú Ìï¥Îãπ ÏõîÏùò Ïù¥Î≤§Ìä∏Îßå Î°úÎìú (Ï§ëÎ≥µ ÏóÜÏù¥)
                        try {
                          await widget.eventManager.loadEventsForMonth(
                            focusedDay,
                          );
                        } catch (e) {
                          print('‚ùå Ïõî Î≥ÄÍ≤Ω Ïãú Ïù¥Î≤§Ìä∏ Î°úÎìú Ïã§Ìå®: $e');
                        }

                        setState(() {});
                      },
                      eventLoader:
                          (day) =>
                              widget.controller
                                  .getEventsForDay(day)
                                  .map((e) => e.title)
                                  .toList(),
                      startingDayOfWeek: StartingDayOfWeek.sunday,
                      headerStyle: HeaderStyle(
                        titleTextStyle: getTextStyle(
                          fontSize: 12,
                          color: Colors.black,
                          text: 'Îã¨Î†• Ï†úÎ™©',
                        ),
                        formatButtonVisible: false,
                        leftChevronVisible: false,
                        rightChevronVisible: false,
                        headerMargin: const EdgeInsets.only(bottom: 8),
                        headerPadding: const EdgeInsets.symmetric(vertical: 10),
                        titleCentered: true,
                      ),
                      daysOfWeekStyle: DaysOfWeekStyle(
                        weekdayStyle: getTextStyle(
                          fontSize: 8,
                          color: Colors.black,
                          text: 'Mon',
                        ),
                        weekendStyle: getTextStyle(
                          fontSize: 8,
                          color: const Color.fromARGB(255, 54, 184, 244),
                          text: 'Sat',
                        ),
                        decoration: BoxDecoration(
                          color: const Color(0xFFEEEEEE),
                          border: Border.all(color: Colors.black, width: 1),
                        ),
                      ),
                      calendarStyle: CalendarStyle(
                        defaultTextStyle: getTextStyle(
                          fontSize: 8,
                          color: Colors.black,
                          text: '1',
                        ),
                        weekendTextStyle: getTextStyle(
                          fontSize: 8,
                          color: Colors.red,
                          text: '1',
                        ),
                        selectedTextStyle: getTextStyle(
                          fontSize: 8,
                          color: Colors.white,
                          text: '1',
                        ),
                        todayTextStyle: getTextStyle(
                          fontSize: 8,
                          color: Colors.black,
                          text: '1',
                        ),
                        outsideTextStyle: getTextStyle(
                          fontSize: 8,
                          color: const Color(0xFF888888),
                          text: '1',
                        ),
                        selectedDecoration: BoxDecoration(
                          color: Colors.blue[800],
                        ),
                        todayDecoration: BoxDecoration(
                          color: Colors.amber[300],
                        ),
                        defaultDecoration: const BoxDecoration(),
                        weekendDecoration: const BoxDecoration(
                          color: Color(0xFFEEEEEE),
                        ),
                        outsideDecoration: const BoxDecoration(
                          color: Color(0xFFDDDDDD),
                        ),
                        tableBorder: TableBorder.all(
                          color: const Color.fromARGB(24, 0, 0, 0),
                          width: 1,
                        ),
                        markersMaxCount: 6,
                        markersAlignment: Alignment.bottomCenter,
                        markerMargin: const EdgeInsets.only(top: 2),
                        markerDecoration: const BoxDecoration(
                          color: Colors.transparent,
                        ),
                        markerSize: 0,
                      ),
                      calendarBuilders: CalendarBuilders(
                        // Í∏∞Î≥∏ ÏÖÄ ÎπåÎçî
                        defaultBuilder: (context, day, focusedDay) {
                          return WeatherCalendarCell(
                            day: day,
                            isSelected: false,
                            isToday: false,
                            onTap: () async {
                              widget.controller.setSelectedDay(day);
                              widget.controller.setFocusedDay(focusedDay);

                              // üî• ÎÇ†Ïßú ÏÑ†ÌÉù ÏãúÏóêÎèÑ Ï§ëÎ≥µ Î°úÎìú Î∞©ÏßÄ
                              if (widget.controller.shouldLoadEventsForDay(
                                day,
                              )) {
                                try {
                                  await widget.eventManager.loadEventsForDay(
                                    day,
                                  );
                                } catch (e) {
                                  print('‚ùå ÎÇ†Ïßú ÏÑ†ÌÉù Ïãú Ïù¥Î≤§Ìä∏ Î°úÎìú Ïã§Ìå®: $e');
                                }
                              }

                              widget.popupManager.showEventDialog();
                              setState(() {});
                            },
                            onLongPress: () {
                              widget.controller.setSelectedDay(day);
                              widget.controller.setFocusedDay(focusedDay);
                              widget.popupManager.showTimeTableDialog();
                              setState(() {});
                            },
                            events: widget.controller.getEventsForDay(day),
                            eventColors: widget.controller.eventColors,
                            eventIdColors: widget.controller.eventIdColors,
                            colorIdColors: widget.controller.colorIdColors,
                            weatherInfo: widget.controller.getWeatherForDay(
                              day,
                            ),
                          );
                        },
                        // ÏÑ†ÌÉùÎêú ÎÇ†Ïßú ÏÖÄ ÎπåÎçî
                        selectedBuilder: (context, day, focusedDay) {
                          return WeatherCalendarCell(
                            day: day,
                            isSelected: true,
                            isToday: false,
                            onTap: () {
                              widget.popupManager.showEventDialog();
                              setState(() {});
                            },
                            onLongPress: () {
                              widget.popupManager.showTimeTableDialog();
                              setState(() {});
                            },
                            events: widget.controller.getEventsForDay(day),
                            eventColors: widget.controller.eventColors,
                            eventIdColors: widget.controller.eventIdColors,
                            colorIdColors: widget.controller.colorIdColors,
                            weatherInfo: widget.controller.getWeatherForDay(
                              day,
                            ),
                          );
                        }, // Ïò§Îäò ÎÇ†Ïßú ÏÖÄ ÎπåÎçî
                        todayBuilder: (context, day, focusedDay) {
                          return WeatherCalendarCell(
                            day: day,
                            isSelected: false,
                            isToday: true,
                            onTap: () async {
                              widget.controller.setSelectedDay(day);
                              widget.controller.setFocusedDay(focusedDay);

                              // üî• ÎÇ†Ïßú ÏÑ†ÌÉù ÏãúÏóêÎèÑ Ï§ëÎ≥µ Î°úÎìú Î∞©ÏßÄ
                              if (widget.controller.shouldLoadEventsForDay(
                                day,
                              )) {
                                try {
                                  await widget.eventManager.loadEventsForDay(
                                    day,
                                  );
                                } catch (e) {
                                  print('‚ùå Ïò§Îäò ÎÇ†Ïßú ÏÑ†ÌÉù Ïãú Ïù¥Î≤§Ìä∏ Î°úÎìú Ïã§Ìå®: $e');
                                }
                              }

                              widget.popupManager.showEventDialog();
                              setState(() {});
                            },
                            onLongPress: () {
                              widget.controller.setSelectedDay(day);
                              widget.controller.setFocusedDay(focusedDay);
                              widget.popupManager.showTimeTableDialog();
                              setState(() {});
                            },
                            events: widget.controller.getEventsForDay(day),
                            eventColors: widget.controller.eventColors,
                            eventIdColors: widget.controller.eventIdColors,
                            colorIdColors: widget.controller.colorIdColors,
                            weatherInfo: widget.controller.getWeatherForDay(
                              day,
                            ),
                          );
                        },
                        // ÏöîÏùº Ìó§Îçî ÎπåÎçî
                        dowBuilder: (context, day) {
                          final weekdayNames = [
                            'Ïõî',
                            'Ìôî',
                            'Ïàò',
                            'Î™©',
                            'Í∏à',
                            'ÌÜ†',
                            'Ïùº',
                          ];
                          final weekdayIndex = day.weekday - 1;
                          Color textColor;
                          if (day.weekday == DateTime.saturday) {
                            textColor = const Color.fromARGB(255, 54, 184, 244);
                          } else if (day.weekday == DateTime.sunday) {
                            textColor = Colors.red;
                          } else {
                            textColor = Colors.black;
                          }
                          return Container(
                            decoration: const BoxDecoration(
                              color: Color(0xFFEEEEEE),
                            ),
                            alignment: Alignment.center,
                            padding: const EdgeInsets.symmetric(vertical: 8.0),
                            child: Text(
                              weekdayNames[weekdayIndex],
                              style: getTextStyle(
                                fontSize: 14,
                                color: textColor,
                                text: weekdayNames[weekdayIndex],
                              ),
                            ),
                          );
                        },
                        // Ìó§Îçî ÌÉÄÏù¥ÌãÄ ÎπåÎçî
                        headerTitleBuilder: (context, month) {
                          final monthNames = [
                            '1Ïõî',
                            '2Ïõî',
                            '3Ïõî',
                            '4Ïõî',
                            '5Ïõî',
                            '6Ïõî',
                            '7Ïõî',
                            '8Ïõî',
                            '9Ïõî',
                            '10Ïõî',
                            '11Ïõî',
                            '12Ïõî',
                          ];
                          return Row(
                            mainAxisAlignment: MainAxisAlignment.spaceBetween,
                            children: [
                              // ÌñÑÎ≤ÑÍ±∞ Î©îÎâ¥ ÏïÑÏù¥ÏΩò Ï∂îÍ∞Ä
                              IconButton(
                                icon: const Icon(
                                  Icons.menu,
                                  color: Colors.black,
                                ),
                                onPressed: () {
                                  Scaffold.of(context).openDrawer();
                                },
                              ), // Ïó∞/Ïõî ÌëúÏãú
                              Expanded(
                                child: Center(
                                  child: Text(
                                    '${month.year}ÎÖÑ ${monthNames[month.month - 1]}',
                                    style: getTextStyle(
                                      fontSize: 20,
                                      color: Colors.black,
                                    ),
                                  ),
                                ),
                              ),
                              // Ïó¨Î∞±ÏùÑ ÏúÑÌïú Ìà¨Î™ÖÌïú ÏïÑÏù¥ÏΩò
                              IconButton(
                                icon: Icon(
                                  Icons.calendar_today,
                                  color: Colors.transparent,
                                ),
                                onPressed: null,
                              ),
                            ],
                          );
                        },
                      ),
                    ),
                  ),
                ),

                // Ïù¥Î≤§Ìä∏ ÌåùÏóÖ Ïò§Î≤ÑÎ†àÏù¥
                if (widget.controller.showEventPopup)
                  EventPopup(
                    selectedDay: widget.controller.selectedDay,
                    events: widget.controller.getEventsForDay(
                      widget.controller.selectedDay,
                    ),
                    eventColors: widget.controller.eventColors,
                    eventIdColors: widget.controller.eventIdColors,
                    colorIdColors: widget.controller.colorIdColors,
                    getEventDisplayColor:
                        (event) =>
                            widget.controller.getEventDisplayColor(event),
                    onClose: () {
                      widget.popupManager.hideEventDialog();
                      setState(() {});
                    },
                    onAddEvent: () {
                      widget.popupManager.showAddEventDialog(context).then((_) {
                        setState(() {});
                      });
                    },
                    onDeleteEvent: (event) async {
                      await widget.eventManager.removeEvent(event);
                      setState(() {});
                    },
                  ),

                // ÌÉÄÏûÑÌÖåÏù¥Î∏î ÌåùÏóÖ Ïò§Î≤ÑÎ†àÏù¥
                if (widget.controller.showTimeTablePopup)
                  TimeTablePopup(
                    selectedDay: widget.controller.selectedDay,
                    timeSlots: widget.controller.getTimeSlotsForDay(
                      widget.controller.selectedDay,
                    ),
                    onClose: () {
                      widget.popupManager.hideTimeTableDialog();
                      setState(() {});
                    },
                    onAddTimeSlot: () {
                      widget.popupManager.showAddTimeSlotDialog(context).then((
                        _,
                      ) {
                        setState(() {});
                      });
                    },
                  ), // ÎÇ†Ïî® ÏòàÎ≥¥ ÌåùÏóÖ Ïò§Î≤ÑÎ†àÏù¥
                if (widget.controller.showWeatherPopup)
                  FutureBuilder<List<WeatherInfo>>(
                    future: WeatherService.get5DayForecast(),
                    builder: (context, snapshot) {
                      // Î°úÎî© Ï§ëÏùº Îïå Î°úÎî© Ïù∏ÎîîÏºÄÏù¥ÌÑ∞ ÌëúÏãú
                      if (snapshot.connectionState == ConnectionState.waiting) {
                        return Center(
                          child: Container(
                            width: MediaQuery.of(context).size.width * 0.7,
                            height: MediaQuery.of(context).size.height * 0.3,
                            decoration: BoxDecoration(
                              color: Colors.white,
                              borderRadius: BorderRadius.circular(16),
                              boxShadow: [
                                BoxShadow(
                                  color: Colors.black.withOpacity(0.3),
                                  blurRadius: 10,
                                ),
                              ],
                            ),
                            child: Column(
                              mainAxisAlignment: MainAxisAlignment.center,
                              children: [
                                CircularProgressIndicator(),
                                SizedBox(height: 16),
                                Text(
                                  'ÎÇ†Ïî® Ï†ïÎ≥¥Î•º Î∂àÎü¨Ïò§Îäî Ï§ë...',
                                  style: TextStyle(fontSize: 16),
                                ),
                              ],
                            ),
                          ),
                        );
                      }

                      // Îç∞Ïù¥ÌÑ∞Í∞Ä Î°úÎìúÎêòÏóàÏúºÎ©¥ ÌåùÏóÖ ÌëúÏãú (5ÏùºÏπòÎßå Ï†úÌïú)
                      List<WeatherInfo> weatherList = snapshot.data ?? [];
                      if (weatherList.length > 5) {
                        weatherList = weatherList.take(5).toList();
                      }

                      return WeatherSummaryPopup(
                        weatherList: weatherList,
                        onClose: () {
                          widget.popupManager.hideWeatherForecastDialog();
                          setState(() {});
                        },
                      );
                    },
                  ),
              ],
            );
          },
        ),
      ),

      // ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò Î∞î
      bottomNavigationBar: CommonNavigationBar(
        selectedIndex: _selectedIndex,
        onItemTapped: _onItemTapped,
      ),
    );
  }

  /// ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò Î∞î ÏïÑÏù¥ÌÖú ÌÉ≠ Ï≤òÎ¶¨
  void _onItemTapped(int index) {
    setState(() {
      _selectedIndex = index;
    });

    switch (index) {
      case 0: // Ï∫òÎ¶∞Îçî - ÌòÑÏû¨ ÌôîÎ©¥Ïù¥ÎØÄÎ°ú ÏïÑÎ¨¥ ÏûëÏóÖ ÏóÜÏùå
        break;
      case 1: // ÎßàÏù¥ÌÅ¨ Î≤ÑÌäº - STT Ïã§Ìñâ
        _showVoiceInput();
        break;
      case 2: // Ï±ÑÌåÖ ÌôîÎ©¥ - EmptyPageÎ°ú Ïù¥Îèô
        _navigateToEmptyPage();
        break;
    }
  }

  /// EmptyPageÎ°ú Ïù¥Îèô
  void _navigateToEmptyPage() async {
    final result = await Navigator.of(context).push(
      MaterialPageRoute(
        builder:
            (context) => EmptyPage(
              onCalendarUpdate: () {
                // Ï±ÑÌåÖÏóêÏÑú Ï∫òÎ¶∞ÎçîÍ∞Ä ÏóÖÎç∞Ïù¥Ìä∏ÎêòÎ©¥ ÌôîÎ©¥ Í∞±Ïã†
                widget.eventManager.refreshCurrentMonthEvents();
                setState(() {});
              },
              eventManager:
                  widget
                      .eventManager, // EventManager Ï†ÑÎã¨ÌïòÏó¨ Google Calendar ÎèôÍ∏∞Ìôî ÌôúÏÑ±Ìôî
            ),
      ),
    );

    // Ï±ÑÌåÖ ÌôîÎ©¥ÏóêÏÑú ÎèåÏïÑÏôîÏùÑ Îïå ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò Î∞î ÏÉÅÌÉú Î¶¨ÏÖã
    if (result != null && result['refreshNavigation'] == true) {
      setState(() {
        _selectedIndex = 0; // Ï∫òÎ¶∞Îçî ÌÉ≠ÏúºÎ°ú Î¶¨ÏÖã
      });
    }
  }

  /// Ïä§ÎÇµÎ∞î ÌëúÏãú
  void _showSnackBar(String message) {
    ScaffoldMessenger.of(
      context,
    ).showSnackBar(SnackBar(content: Text(message)));
  }

  /// ÏùåÏÑ± ÏûÖÎ†• Îã§Ïù¥ÏñºÎ°úÍ∑∏ ÌëúÏãú
  void _showVoiceInput() {
    VoiceCommandService.instance.showVoiceInput(
      context: context,
      eventManager: widget.eventManager, // EventManager Ï†ÑÎã¨
      onCommandProcessed: _handleVoiceCommandResponse,
      onCalendarUpdate: () async {
        print('üîÑ CalendarWidget: Ï∫òÎ¶∞Îçî ÏóÖÎç∞Ïù¥Ìä∏ ÏΩúÎ∞± Î∞õÏùå');

        // ÌòÑÏû¨ ÏÑ†ÌÉùÎêú ÎÇ†ÏßúÏùò Ïù¥Î≤§Ìä∏ Í∞ïÏ†ú ÏÉàÎ°úÍ≥†Ïπ®
        await widget.eventManager.loadEventsForDay(
          widget.controller.selectedDay,
          forceRefresh: true,
        );

        // Ïõî Ï†ÑÏ≤¥ Ïù¥Î≤§Ìä∏ÎèÑ ÏÉàÎ°úÍ≥†Ïπ® (Î∞±Í∑∏ÎùºÏö¥ÎìúÎ°ú Ï≤òÎ¶¨)
        widget.eventManager.refreshCurrentMonthEvents().then((_) {
          print('üîÑ Ïõî Ï†ÑÏ≤¥ Ïù¥Î≤§Ìä∏ ÏÉàÎ°úÍ≥†Ïπ® ÏôÑÎ£å');
        });

        // UI ÏÉàÎ°úÍ≥†Ïπ®
        setState(() {});
      },
    );
  }

  /// ÏùåÏÑ± Î™ÖÎ†π Ï≤òÎ¶¨ Í≤∞Í≥ºÏóê Îî∞Î•∏ Ïï°ÏÖò
  void _handleVoiceCommandResponse(String response, String command) {
    print('üé§ CalendarWidget: STT Î™ÖÎ†π Ï≤òÎ¶¨ - Î™ÖÎ†π: "$command", ÏùëÎãµ: "$response"');

    // Ïä§ÎÇµÎ∞îÎ°ú ÏùëÎãµ ÌëúÏãú
    _showSnackBar(response);

    // Ï∫òÎ¶∞Îçî Í¥ÄÎ†® Î™ÖÎ†πÏñ¥ Ï≤òÎ¶¨
    VoiceCommandService.instance.processCalendarCommand(
      command,
      widget.controller,
      widget.popupManager,
      widget.eventManager,
      () => setState(() {}),
    );

    // Î™®Îì† ÏùåÏÑ± Î™ÖÎ†π ÌõÑ Ìï≠ÏÉÅ ÌôîÎ©¥ Í∞±Ïã† Î∞è Ïù¥Î≤§Ìä∏ ÏÉàÎ°úÍ≥†Ïπ® - ÏùºÏ†ï Ï∂îÍ∞Ä ÎàÑÎùΩ Î¨∏Ï†ú Ìï¥Í≤∞
    print('üîÑ ÏùåÏÑ± Î™ÖÎ†π ÌõÑ Ïù¥Î≤§Ìä∏ Í∞ïÏ†ú ÏÉàÎ°úÍ≥†Ïπ®');
    widget.eventManager.refreshCurrentMonthEvents().then((_) {
      // ÌòÑÏû¨ ÏÑ†ÌÉùÎêú ÎÇ†ÏßúÏùò Ïù¥Î≤§Ìä∏ÎèÑ Í∞ïÏ†ú Í∞±Ïã†
      widget.eventManager
          .loadEventsForDay(widget.controller.selectedDay, forceRefresh: true)
          .then((_) {
            // UI Í∞±Ïã†
            setState(() {});
          });
    });
  }
}
